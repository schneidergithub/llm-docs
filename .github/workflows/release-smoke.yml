name: release-smoke

on:
  pull_request:
    paths:
      - ".github/workflows/release.yml"
      - ".github/workflows/release-smoke.yml"
      - "tools/build_corpus.py"
      - "tools/validate_docs.py"
      - "tools/requirements.txt"
      - "schema/**"
      - "docs/**"
  workflow_dispatch:
    inputs:
      version:
        description: "Optional test version (defaults to corpus-v2099.01.0)"
        required: false
        type: string

jobs:
  smoke:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve test version
        id: version
        run: |
          VERSION="${{ github.event.inputs.version }}"
          if [ -z "${VERSION}" ]; then
            VERSION="corpus-v2099.01.0"
          fi
          if ! echo "${VERSION}" | grep -Eq '^corpus-v[0-9]{4}\.[0-9]{2}\.[0-9]+$'; then
            echo "::error::Invalid version '${VERSION}'. Expected corpus-vYYYY.MM.patch"
            exit 1
          fi
          echo "version=${VERSION}" >> "${GITHUB_OUTPUT}"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r tools/requirements.txt

      - name: Validate docs
        run: |
          python tools/validate_docs.py

      - name: Build corpus (smoke)
        env:
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          python tools/build_corpus.py --corpus-version "${VERSION}" --out-dir dist/.release_smoke

      - name: Verify manifest version and generate checksums
        env:
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          BUILT_VERSION=$(python -c "import json; from pathlib import Path; manifest=json.loads(Path('dist/.release_smoke/manifest.json').read_text(encoding='utf-8')); print(manifest['corpus_version'])")
          if [ "${BUILT_VERSION}" != "${VERSION}" ]; then
            echo "::error::Manifest corpus_version '${BUILT_VERSION}' does not match expected '${VERSION}'."
            exit 1
          fi

          (
            cd dist/.release_smoke
            shasum -a 256 corpus.jsonl index.json manifest.json > SHA256SUMS
          )

      - name: Upload smoke artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-smoke-${{ steps.version.outputs.version }}
          path: |
            dist/.release_smoke/corpus.jsonl
            dist/.release_smoke/index.json
            dist/.release_smoke/manifest.json
            dist/.release_smoke/SHA256SUMS
