name: release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Corpus version in format corpus-vYYYY.MM.patch"
        required: true
        type: string

permissions:
  contents: write

concurrency:
  group: release-corpus
  cancel-in-progress: false

jobs:
  build-tag-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Enforce main branch
        run: |
          if [ "${GITHUB_REF}" != "refs/heads/main" ]; then
            echo "::error::Releases must run from main. Current ref: ${GITHUB_REF}"
            exit 1
          fi


      - name: Validate version format
        id: validate_version
        run: |
          VERSION="${{ inputs.version }}"
          if ! echo "${VERSION}" | grep -Eq '^corpus-v[0-9]{4}\.[0-9]{2}\.[0-9]+$'; then
            echo "::error::Invalid version '${VERSION}'. Expected corpus-vYYYY.MM.patch"
            exit 1
          fi
          echo "version=${VERSION}" >> "${GITHUB_OUTPUT}"

      - name: Ensure tag does not already exist
        run: |
          VERSION="${{ steps.validate_version.outputs.version }}"
          git fetch --tags --force
          if git rev-parse -q --verify "refs/tags/${VERSION}" >/dev/null; then
            echo "::error::Tag ${VERSION} already exists."
            exit 1
          fi


      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r tools/requirements.txt

      - name: Validate docs
        run: |
          python tools/validate_docs.py

      - name: Build corpus
        env:
          VERSION: ${{ steps.validate_version.outputs.version }}
        run: |
          python tools/build_corpus.py --corpus-version "${VERSION}" --out-dir dist/.release_tmp

      - name: Verify manifest version
        env:
          VERSION: ${{ steps.validate_version.outputs.version }}
        run: |
          BUILT_VERSION=$(python -c "import json; from pathlib import Path; manifest=json.loads(Path('dist/.release_tmp/manifest.json').read_text(encoding='utf-8')); print(manifest['corpus_version'])")
          if [ "${BUILT_VERSION}" != "${VERSION}" ]; then
            echo "::error::Manifest corpus_version '${BUILT_VERSION}' does not match requested version '${VERSION}'."
            exit 1
          fi


      - name: Stage release artifacts
        env:
          VERSION: ${{ steps.validate_version.outputs.version }}
        run: |
          if [ -d "dist/releases/${VERSION}" ]; then
            echo "::error::dist/releases/${VERSION} already exists. Refusing to overwrite."
            exit 1
          fi
          mkdir -p "dist/releases/${VERSION}" "dist/latest"
          cp "dist/.release_tmp/corpus.jsonl" "dist/releases/${VERSION}/corpus.jsonl"
          cp "dist/.release_tmp/index.json" "dist/releases/${VERSION}/index.json"
          cp "dist/.release_tmp/manifest.json" "dist/releases/${VERSION}/manifest.json"
          cp "dist/.release_tmp/corpus.jsonl" "dist/latest/corpus.jsonl"
          cp "dist/.release_tmp/index.json" "dist/latest/index.json"
          cp "dist/.release_tmp/manifest.json" "dist/latest/manifest.json"
          (
            cd "dist/releases/${VERSION}"
            shasum -a 256 corpus.jsonl index.json manifest.json > SHA256SUMS
          )
          rm -rf dist/.release_tmp

      - name: Commit release artifacts to main
        env:
          VERSION: ${{ steps.validate_version.outputs.version }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add "dist/releases/${VERSION}" "dist/latest"
          if git diff --cached --quiet; then
            echo "::error::No artifact changes found to commit."
            exit 1
          fi
          git commit -m "release: ${VERSION}"
          git push origin HEAD:main


      - name: Create and push annotated tag
        env:
          VERSION: ${{ steps.validate_version.outputs.version }}
        run: |
          git tag -a "${VERSION}" -m "Corpus release ${VERSION}"
          git push origin "${VERSION}"


      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.validate_version.outputs.version }}
          target_commitish: main
          files: |
            dist/releases/${{ steps.validate_version.outputs.version }}/corpus.jsonl
            dist/releases/${{ steps.validate_version.outputs.version }}/index.json
            dist/releases/${{ steps.validate_version.outputs.version }}/manifest.json
            dist/releases/${{ steps.validate_version.outputs.version }}/SHA256SUMS

